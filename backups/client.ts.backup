'use client';
import { createBrowserClient } from '@supabase/ssr';

// Debug environment variables
logger.log('ðŸ” Environment variables check:', {
  url: process.env.NEXT_PUBLIC_SUPABASE_URL,
  key: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ? 'present' : 'missing',
  googleMaps: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY ? 'present' : 'missing'
});

export const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://lwhxmwvvostzlidmnays.supabase.co',
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHhtd3Z2b3N0emxpZG1uYXlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTg2NDYsImV4cCI6MjA3NDM5NDY0Nn0.YeXIZyYKuxVictEKcWe9GRsgMlVoFQJAPawdsIy8ye8',
  {
    auth: {
      autoRefreshToken: true, // Enable auto-refresh but with better rate limiting
      detectSessionInUrl: false, // CRITICAL: Prevent URL-based session detection
      persistSession: true, // Persist session to reduce auth calls
      flowType: 'pkce' // Use PKCE flow for better security
    },
    cookies: {
      get(name: string) {
        if (typeof document === 'undefined') return undefined;
        
        const value = document.cookie
          .split('; ')
          .find(row => row.startsWith(`${name}=`))
          ?.split('=')[1];
        
        // CRITICAL: Reduce logging to prevent console spam
        // Removed excessive auth cookie logging
        return value;
      },
      set(name: string, value: string, options: Record<string, unknown> = {}) {
        if (typeof document === 'undefined') return;
        
        try {
          // Enhanced cookie options for mobile compatibility
          // CRITICAL: Don't set domain for localhost or when it might cause issues
          // Only set domain for production domains that need cross-subdomain support
          const hostname = window.location.hostname;
          const cookieOptions: Record<string, unknown> = {
            path: '/',
            secure: window.location.protocol === 'https:',
            sameSite: 'lax' as const,
            maxAge: 60 * 60 * 24 * 7, // 7 days
            ...options
          };
          
          // Only set domain if not localhost and not an IP address
          if (!hostname.includes('localhost') && !hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
            // For production, don't set domain to allow subdomain flexibility
            // Setting domain can cause cookies not to work properly
          }
          
          // Handle mobile-specific cookie setting
          let cookieString = `${name}=${value}`;
          
          if (cookieOptions.maxAge) {
            const expires = new Date(Date.now() + (cookieOptions.maxAge as number) * 1000);
            cookieString += `; expires=${expires.toUTCString()}`;
          }
          
          if (cookieOptions.path) cookieString += `; path=${cookieOptions.path}`;
          // Don't set domain - let browser handle it
          if (cookieOptions.secure) cookieString += `; secure`;
          if (cookieOptions.sameSite) cookieString += `; samesite=${cookieOptions.sameSite}`;
          
          document.cookie = cookieString;
          // CRITICAL: Reduce logging to prevent console spam
          // Removed excessive auth cookie logging
        } catch (error) {
          logger.error('Error setting mobile cookie:', error);
        }
      },
      remove(name: string, options: Record<string, unknown> = {}) {
        if (typeof document === 'undefined') return;
        
        try {
          const cookieOptions = {
            path: '/',
            ...options
          };
          
          let cookieString = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC`;
          if (cookieOptions.path) cookieString += `; path=${cookieOptions.path}`;
          // Don't set domain - let browser handle it
          
          document.cookie = cookieString;
          // CRITICAL: Reduce logging to prevent console spam
          // Removed excessive auth cookie logging
        } catch (error) {
          logger.error('Error removing mobile cookie:', error);
        }
      }
    }
  }
);
